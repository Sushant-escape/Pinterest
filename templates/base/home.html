{% extends 'base.html' %}

{% block content %}
{% if not request.user.is_authenticated and not query %}
<div class="hero-section">
    <div class="hero-content">
        <h1>Get your next idea</h1>
        <p class="hero-sub">Search for images, save them to your boards, or download them for your projects.</p>
        <div class="hero-buttons">
            <a href="{% url 'accounts:signup' %}" class="btn-primary btn-large">Sign up</a>
            <a href="{% url 'core:explore' %}" class="btn-secondary btn-large">Explore</a>
        </div>
    </div>
    <div class="hero-overlay"></div>
</div>
{% endif %}

<div class="masonry-grid {% if not request.user.is_authenticated and not query %}no-hero-margin{% endif %}"
    data-authenticated="{{ request.user.is_authenticated|yesno:'true,false' }}"
    data-login-url="{% url 'accounts:login' %}">
    {% for pin in pins %}
    <div class="pin-card">
        {% if pin.is_external %}
        <div class="pin-image-wrapper external-link" data-image-url="{{ pin.image.url }}" data-title="{{ pin.title }}"
            data-author="{{ pin.user.username }}" data-author-image="{{ pin.user.profile_image.url }}"
            data-source-url="{{ pin.remote_link }}">
            <img src="{{ pin.image.url }}" alt="{{ pin.title }}" loading="lazy">
            <div class="pin-overlay">
                <button class="btn-save"
                    onclick="event.stopPropagation(); showImageModal(event, this.parentElement.parentElement)">Save</button>
            </div>
        </div>
        {% else %}
        <div class="pin-image-wrapper">
            <a href="{% url 'pins:pin_detail' pin.id %}">
                <img src="{{ pin.image.url }}" alt="{{ pin.title }}" loading="lazy">
            </a>
            <div class="pin-overlay" data-url="{% url 'pins:pin_detail' pin.id %}"
                onclick="window.location.href=this.dataset.url">
                <button class="btn-save"
                    onclick="event.stopPropagation(); saveLocalPin(event, '{{ pin.id }}', this)">Save</button>
            </div>
        </div>
        {% endif %}

        <div class="pin-info">
            {% if pin.title %}
            <a href="{% if pin.is_external %}#{% else %}{% url 'pins:pin_detail' pin.id %}{% endif %}" {% if
                pin.is_external
                %}onclick="showImageModal(event, this.closest('.pin-card').querySelector('.pin-image-wrapper'))" {%
                endif %}>
                <h3>{{ pin.title|truncatechars:30 }}</h3>
            </a>
            {% endif %}

            {% if pin.user %}
            <div class="pin-user">
                {% if pin.user.profile_image %}
                <img src="{{ pin.user.profile_image.url }}" class="user-avatar-small" alt="{{ pin.user.username }}">
                {% else %}
                <div class="user-avatar-small"
                    style="background: #efefef; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-user" style="font-size: 12px; color: #767676;"></i>
                </div>
                {% endif %}
                <span>{{ pin.user.username }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% if not pins %}
{% if query %}
<div class="empty-state">
    {% if missing_key %}
    <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #ff9800; margin-bottom: 16px;"></i>
    <h2>Unsplash API Key Missing</h2>
    <p>To enable web search, please add your <code>UNSPLASH_ACCESS_KEY</code> to the <code>.env</code> file.</p>
    <p>Check the <code>.env.example</code> file for reference.</p>
    {% else %}
    <h2>No results found for "{{ query }}"</h2>
    <p>Try searching for something else.</p>
    {% endif %}
    <a href="{% url 'core:home' %}" class="btn-secondary">Clear Search</a>
</div>
{% elif request.user.is_authenticated %}
<div class="empty-state">
    <h2>Welcome to your feed</h2>
    <p>Follow people or boards to see pins here.</p>
    <a href="{% url 'core:explore' %}" class="btn-primary">Explore Ideas</a>
</div>
{% endif %}
{% endif %}

<!-- Image Modal for External Images -->
<div id="imageModal" class="image-modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeImageModal()"></div>
    <div class="modal-content">
        <button class="modal-close" onclick="closeImageModal()">&times;</button>
        <div class="modal-body">
            <div class="modal-image-container">
                <img id="modalImage" src="" alt="">
            </div>
            <div class="modal-info">
                <h2 id="modalTitle"></h2>
                <div class="modal-author">
                    <img id="modalAuthorImage" src="" class="user-avatar-small">
                    <span id="modalAuthor"></span>
                </div>
                <div class="modal-actions">
                    <button class="btn-red" onclick="downloadImage()" id="downloadBtn">
                        <i class="fas fa-download"></i> Download
                    </button>
                    {% if request.user.is_authenticated %}
                    <div class="board-select-wrapper">
                        <select id="boardSelect" class="board-select">
                            <option value="">Select a board (optional)</option>
                            {% for board in request.user.boards.all %}
                            <option value="{{ board.id }}">{{ board.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button class="btn-gray" onclick="saveToBoard()" id="saveBtn">
                        <i class="fas fa-bookmark"></i> Save to My Pins
                    </button>
                    {% endif %}
                    <a id="modalSourceLink" href="" target="_blank" class="btn-outline">
                        <i class="fab fa-unsplash"></i> View on Unsplash
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .image-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.82);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
    }

    .modal-content {
        position: relative;
        max-width: 960px;
        width: 90%;
        max-height: 90vh;
        background: white;
        border-radius: 32px;
        overflow: hidden;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        display: flex;
        z-index: 10000;
        animation: modalEntrance 0.5s cubic-bezier(0.165, 0.84, 0.44, 1);
    }

    @keyframes modalEntrance {
        from {
            opacity: 0;
            transform: scale(0.95) translateY(20px);
        }

        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .modal-close {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 44px;
        height: 44px;
        border: none;
        background: white;
        color: #111;
        font-size: 20px;
        border-radius: 50%;
        cursor: pointer;
        z-index: 10001;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .modal-close:hover {
        background: #f0f0f0;
        transform: rotate(90deg) scale(1.1);
    }

    .modal-body {
        display: flex;
        width: 100%;
        height: 100%;
    }

    .modal-image-container {
        flex: 1.2;
        background: #f7f7f7;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .modal-image-container img {
        max-width: 100%;
        max-height: 90vh;
        object-fit: contain;
    }

    .modal-info {
        flex: 0.8;
        padding: 40px;
        display: flex;
        flex-direction: column;
        background: white;
        border-left: 1px solid #efefef;
    }

    .modal-info h2 {
        font-size: 32px;
        font-weight: 800;
        margin-bottom: 24px;
        color: #111;
        letter-spacing: -0.5px;
        line-height: 1.2;
    }

    .modal-author {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 32px;
    }

    .modal-author span {
        font-weight: 700;
        font-size: 18px;
    }

    .modal-actions {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-top: auto;
    }

    .modal-actions button,
    .modal-actions a {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 16px 24px;
        border-radius: 24px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none;
        border: none;
    }

    .btn-red {
        background: #e60023;
        color: white;
    }

    .btn-red:hover {
        background: #ad081b;
        transform: scale(1.02);
    }

    .btn-gray {
        background: #efefef;
        color: #111;
    }

    .btn-gray:hover {
        background: #e2e2e2;
        transform: scale(1.02);
    }

    .btn-outline {
        background: transparent;
        border: 2px solid #efefef !important;
        color: #111;
    }

    .btn-outline:hover {
        background: #f7f7f7;
        border-color: #ddd !important;
    }

    .board-select {
        width: 100%;
        padding: 14px 20px;
        border: 2px solid #efefef;
        border-radius: 16px;
        font-size: 16px;
        font-weight: 600;
        background: white;
        color: #111;
        cursor: pointer;
        transition: border-color 0.2s;
    }

    .board-select:focus {
        outline: none;
        border-color: #111;
    }

    @media (max-width: 900px) {
        .modal-content {
            flex-direction: column;
            max-height: 95vh;
        }

        .modal-image-container {
            max-height: 50vh;
        }

        .modal-info {
            padding: 24px;
        }
    }

    .pin-image-wrapper {
        position: relative;
        border-radius: 20px;
        overflow: hidden;
        background: #efefef;
    }

    .pin-image-wrapper img {
        width: 100%;
        display: block;
        transition: transform 0.3s ease;
    }

    .pin-image-wrapper:hover img {
        transform: scale(1.03);
    }
</style>

<script>
    function saveLocalPin(event, pinId, buttonElement) {
        event.preventDefault();
        event.stopPropagation();

        const grid = document.querySelector('.masonry-grid');
        const isAuthenticated = grid.dataset.authenticated === 'true';
        const loginUrl = grid.dataset.loginUrl;

        if (!isAuthenticated) {
            window.location.href = loginUrl;
            return;
        }

        const originalText = buttonElement.innerHTML;
        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        buttonElement.disabled = true;

        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch(`/pins/${pinId}/save/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    buttonElement.innerHTML = '<i class="fas fa-check"></i> Saved!';
                    buttonElement.classList.add('btn-saved');
                    setTimeout(() => {
                        buttonElement.innerHTML = originalText;
                        buttonElement.disabled = false;
                    }, 2000);
                } else {
                    alert('Error: ' + (data.error || 'Could not save pin'));
                    buttonElement.innerHTML = originalText;
                    buttonElement.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error saving pin:', error);
                buttonElement.innerHTML = originalText;
                buttonElement.disabled = false;
            });
    }

    let currentImageData = {};

    function showImageModal(event, element) {
        event.preventDefault();

        currentImageData = {
            imageUrl: element.dataset.imageUrl,
            title: element.dataset.title,
            author: element.dataset.author,
            authorImage: element.dataset.authorImage,
            sourceUrl: element.dataset.sourceUrl
        };

        document.getElementById('modalImage').src = currentImageData.imageUrl;
        document.getElementById('modalTitle').textContent = currentImageData.title;
        document.getElementById('modalAuthor').textContent = currentImageData.author;
        document.getElementById('modalAuthorImage').src = currentImageData.authorImage;
        document.getElementById('modalSourceLink').href = currentImageData.sourceUrl;

        document.getElementById('imageModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeImageModal() {
        document.getElementById('imageModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function downloadImage() {
        const downloadBtn = document.getElementById('downloadBtn');
        const originalText = downloadBtn.innerHTML;
        downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Downloading...';
        downloadBtn.disabled = true;

        const filename = currentImageData.title.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.jpg';

        // Create form data
        const formData = new FormData();
        formData.append('image_url', currentImageData.imageUrl);
        formData.append('filename', filename);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        // Download via backend to avoid CORS issues
        fetch('{% url "core:download_unsplash" %}', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) throw new Error('Download failed');
                return response.blob();
            })
            .then(blob => {
                // Create a download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                downloadBtn.innerHTML = '<i class="fas fa-check"></i> Downloaded!';
                setTimeout(() => {
                    downloadBtn.innerHTML = originalText;
                    downloadBtn.disabled = false;
                }, 2000);
            })
            .catch(error => {
                console.error('Download error:', error);
                downloadBtn.innerHTML = '<i class="fas fa-times"></i> Failed';
                setTimeout(() => {
                    downloadBtn.innerHTML = originalText;
                    downloadBtn.disabled = false;
                }, 2000);
            });
    }

    function saveToBoard() {
        const saveBtn = document.getElementById('saveBtn');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        saveBtn.disabled = true;

        const boardSelect = document.getElementById('boardSelect');
        const boardId = boardSelect ? boardSelect.value : '';

        // Create form data
        const formData = new FormData();
        formData.append('image_url', currentImageData.imageUrl);
        formData.append('title', currentImageData.title);
        formData.append('author', currentImageData.author);
        if (boardId) {
            formData.append('board_id', boardId);
        }
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        // Save to backend
        fetch('{% url "core:save_unsplash" %}', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
                    setTimeout(() => {
                        closeImageModal();
                        saveBtn.innerHTML = originalText;
                        saveBtn.disabled = false;
                        // Optional: Show success message
                        alert('Image saved to your pins successfully!');
                    }, 1500);
                } else {
                    throw new Error(data.error || 'Save failed');
                }
            })
            .catch(error => {
                console.error('Save error:', error);
                alert('Failed to save image: ' + error.message);
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closeImageModal();
        }
    });
</script>
{% endblock %}